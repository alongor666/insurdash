# 模块文档：图表 - 帕累托分析

- **组件路径(s)**: `src/components/dashboard/charts/pareto-chart.tsx`
- **模块负责人**: `TBD`
- **最后更新**: `2024-08-01`
- **文档版本**: `v1.0.0`
- **变更记录**:
  - `v1.0.0` - 初始创建 by AI Guardian

---

## 1. 核心目标 (Core Objective)
结合条形图与折线图，进行经典的“二八法则”(80/20)分析，帮助用户快速识别出贡献了大部分结果（如80%的保费或赔款）的关键业务线。

## 2. 数据源与模型
- **输入**: `data` (类型为 `ProcessedBusinessData[]`)，包含所有经过筛选的业务线数据。
- **内部状态**: `selectedKpi`，存储用户选择的、用于帕累托分析的主指标 `KpiKey`。
- **派生数据**: `paretoData`，通过 `useMemo` hook 派生而来，是图表的核心数据源。其计算逻辑为：
  1.  根据 `selectedKpi` 对输入的 `data` 进行**降序排序**。
  2.  计算出该KPI的总和。
  3.  遍历排序后的数据，为每一项计算一个**累计贡献百分比** (`cumulativePercentage`)。

## 3. 核心功能与交互逻辑
### 3.1. 指标选择
- **交互**: 图表顶部提供一个下拉选择器 (`Select`)，允许用户选择一个数值型KPI（限定于 `DONUT_PARETO_KPI_IDS`）作为分析依据。
- **逻辑**: 选择新KPI会更新 `selectedKpi` 状态，触发 `paretoData` 的重新计算和图表的重渲染。

### 3.2. 图表渲染 (复合图表)
- **组件**: 使用 Recharts 的 `ComposedChart` 复合图表，在一个图表中同时渲染条形和折线。
- **条形图 (`Bar`)**:
  - **Y轴**: 对应左侧Y轴，显示每个业务线在所选KPI上的**具体数值**。
  - **排序**: X轴上的业务线按其贡献度从高到低排列。
  - **颜色**: 每个条形的颜色由其自身的 `variable_cost_ratio` 决定，遵循全局动态风险色系统。
- **折线图 (`Line`)**:
  - **Y轴**: 对应**右侧Y轴**，显示一条**累计贡献百分比曲线**。
  - **作用**: 帮助用户快速定位到累计贡献达到80%或90%的关键业务线。
- **双Y轴**: 左侧Y轴对应条形图的数值单位，右侧Y轴对应折线图的百分比单位（0-100%）。

### 3.3. 数据洞察 (Tooltip)
- **交互**: 鼠标悬浮在图表上时，会显示一个自定义的工具提示框 (`CustomTooltip`)。
- **内容**: 提示框会同时显示该业务线在主指标上的**具体值**、**累计占比**，以及其**变动成本率**，提供全面的分析视角。

## 4. 关系图谱 (Relationship Map)
- **关联全局宪法 `PRD.md`**:
  - 条形颜色逻辑严格遵循 `PRD.md §6` 中定义的“动态风险色”系统。
- **与其他模块的交互**:
  - **依赖**:
    - `data-pipeline.md`: 依赖其提供的 `formatKpiValue` 函数和 `KPIS` 配置。
    - `Global UI`: 依赖其颜色系统 (`getDynamicColorByVCR`)。
    - `dashboard-context.md` (间接): 其父组件 `ChartsSection` 从Context获取数据并传递给它。

## 5. 修改与维护指南
- **修改可选指标**: 可选的KPI列表由 `src/lib/kpi-config.ts` 中的 `DONUT_PARETO_KPI_IDS` 定义。
- **修改排序逻辑**: 排序逻辑在 `paretoData` 的 `useMemo` 计算中，可以根据需要调整为升序或修改排序依据。
