
# 模块文档：图表 - 多维气泡图

- **组件路径(s)**: `src/components/dashboard/charts/bubble-chart.tsx`
- **模块负责人**: `TBD`
- **最后更新**: `2024-08-01`
- **文档版本**: `v1.0.0`
- **变更记录**:
  - `v1.0.0` - 初始创建 by AI Guardian

---

## 1. 核心目标 (Core Objective)
在一个二维平面上，通过气泡的位置（X/Y轴）和大小（Z轴），同时对不同业务线的三个可自定义指标进行比较，从而在一个视图中发现多维度的关联和异常。

## 2. 数据源与模型
- **输入**: `data` (类型为 `ProcessedBusinessData[]`)，包含所有经过筛选和计算的业务线数据。
- **内部状态**:
  - `xMetric`, `yMetric`, `zMetric`: 分别存储用户为X轴、Y轴和气泡大小所选择的 `KpiKey`。
- **派生数据**: `chartData`，根据用户选择的三个指标，从原始`data`中动态映射出 `x`, `y`, `z` 值，并计算每个气泡的填充色。

## 3. 核心功能与交互逻辑
### 3.1. 指标选择
- **交互**: 图表顶部提供三个独立的下拉选择器 (`Select`)，分别用于控制X轴、Y轴和气泡大小所代表的KPI。
- **逻辑**: 每次选择一个新的KPI，都会更新对应的内部状态（`xMetric`, `yMetric`, or `zMetric`），这会触发 `chartData` 的重新计算和图表的重新渲染。

### 3.2. 图表渲染
- **组件**: 使用 Recharts 的 `ScatterChart` 组件进行渲染。
- **坐标轴**: X轴和Y轴根据所选指标的名称和单位动态生成标签。数值会使用 `formatKpiValue` 工具函数进行格式化，以提高可读性。
- **气泡大小**: Z轴 (`ZAxis`) 将 `z` 值（所选KPI的数值）映射到一个视觉上的大小范围 (`range=[100, 1000]`)。
- **气泡颜色**: 每个气泡（代表一个业务线）的颜色由其自身的 `variable_cost_ratio` (变动成本率) 决定，通过 `getDynamicColorByVCR` 函数计算得出，直观反映业务健康度。

### 3.3. 数据洞察 (Tooltip)
- **交互**: 鼠标悬浮在气泡上时，会显示一个自定义的工具提示框 (`CustomTooltip`)。
- **内容**: 提示框清晰地展示该业务线的名称、X/Y/Z三个轴所代表指标的精确值，以及该业务线的“变动成本率”及其对应的风险颜色。

## 4. 关系图谱 (Relationship Map)
- **关联全局宪法 `PRD.md`**:
  - 气泡颜色逻辑严格遵循 `PRD.md §6` 中定义的“动态风险色”系统。
- **与其他模块的交互**:
  - **依赖**:
    - `data-pipeline.md`: 依赖其提供的 `formatKpiValue` 函数和 `KPIS` 配置。
    - `Global UI`: 依赖其颜色系统 (`getDynamicColorByVCR`)。
    - `dashboard-context.md` (间接): 其父组件 `ChartsSection` 从Context获取数据并传递给它。

## 5. 修改与维护指南
- **修改可选指标**: 如果要限制可选的KPI范围，可以直接修改组件内的 `chartableKpis` 数组。
- **调整气泡大小范围**: 修改 `ZAxis` 组件的 `range` prop 即可调整视觉大小的映射。
- **风险点**: 性能。如果业务线数量非常多，同时渲染大量气泡可能会有性能压力。未来可考虑虚拟化或聚合等优化方案。
